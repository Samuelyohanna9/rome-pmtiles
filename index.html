<script>
  // Register pmtiles:// protocol
  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  // Global Protomaps basemap (vector PMTiles)
  const BASEMAP_PM = "pmtiles://https://pmtiles.protomaps.com/20240401.pmtiles";
  const basemapSourceId = "basemap";

  // Explicitly add archives to the protocol (helps initialization)
  const basemapArchive = new pmtiles.PMTiles("https://pmtiles.protomaps.com/20240401.pmtiles");
  protocol.add(basemapArchive);

  const orthoArchive = new pmtiles.PMTiles("https://maps.greenspaces.cloud/Naples/part_of_napoli_orthophoto.pmtiles");
  protocol.add(orthoArchive);

  // Protomaps style for the basemap
  const style = {
    version: 8,
    glyphs: "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",
    sprite: "https://protomaps.github.io/basemaps-assets/sprites/v4/light",
    sources: {
      [basemapSourceId]: {
        type: "vector",
        url: BASEMAP_PM,
        attribution: '<a href="https://protomaps.com">Protomaps</a> © <a href="https://openstreetmap.org">OpenStreetMap</a>'
      }
    },
    layers: basemaps.layers(basemapSourceId, basemaps.namedFlavor("light"), { lang: "en" })
  };

  // Add a neutral background at the very bottom
  style.layers = [
    { id: "background", type: "background", paint: { "background-color": "#f2f2f2" } },
    ...style.layers
  ];

  // Initialize MapLibre
  const map = new maplibregl.Map({
    container: "map",
    style,
    center: [14.2681, 40.8518], // Naples
    zoom: 12,
    hash: true
  });

  // Controls
  map.addControl(new maplibregl.NavigationControl(), "top-right");
  map.addControl(new maplibregl.ScaleControl({ unit: "metric" }));
  map.addControl(new maplibregl.AttributionControl({ compact: true }));

  // Log any load errors
  map.on("error", (e) => console.error("Map error:", e && e.error ? e.error : e));

  // Helper: insert orthophoto beneath labels
  function firstSymbolLayerId() {
    const layers = map.getStyle().layers || [];
    for (const l of layers) if (l.type === "symbol") return l.id;
    return undefined;
  }

  map.on("load", () => {
    // Orthophoto raster PMTiles
    map.addSource("naples-ortho", {
      type: "raster",
      url: "pmtiles://https://maps.greenspaces.cloud/Naples/part_of_napoli_orthophoto.pmtiles",
      tileSize: 512,
      attribution: "© Company Orthophoto"
    });

    const beforeId = firstSymbolLayerId();
    map.addLayer(
      { id: "naples-ortho", type: "raster", source: "naples-ortho", minzoom: 0, maxzoom: 22 },
      beforeId
    );

    // Toggle visibility
    document.getElementById("orthoToggle").onchange = (e) => {
      map.setLayoutProperty("naples-ortho", "visibility", e.target.checked ? "visible" : "none");
    };
  });

  // Optional: click to inspect vector features
  map.on("click", (e) => {
    const features = map.queryRenderedFeatures(e.point);
    if (features && features.length) {
      const f = features[0];
      const props = Object.entries(f.properties || {})
        .map(([k, v]) => `<div><strong>${k}</strong>: ${String(v)}</div>`)
        .join("");
      new maplibregl.Popup().setLngLat(e.lngLat).setHTML(props || "No properties").addTo(map);
    }
  });
</script>
